<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cat√°logo de Im√≥veis</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .header { text-align: center; padding: 20px 0; margin-bottom: 20px; }
        .header h1 { font-size: 1.5rem; color: #fff; margin-bottom: 5px; }
        .header p { color: #8892b0; font-size: 0.9rem; }
        .stats { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
        .stat-item { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 1.5rem; font-weight: bold; color: #64ffda; }
        .stat-label { font-size: 0.75rem; color: #8892b0; }
        .config-banner { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .config-banner h3 { margin-bottom: 8px; }
        .config-banner p { font-size: 0.85rem; opacity: 0.9; }
        .config-banner button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 8px; background: rgba(0,0,0,0.2); color: #fff; font-weight: 600; cursor: pointer; }
        .tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 0.9rem; }
        .tab.active { background: #64ffda; color: #1a1a2e; }
        .tab:not(.active) { color: #8892b0; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #ccd6f6; font-size: 0.85rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; background: rgba(255,255,255,0.05); color: #fff; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #64ffda; }
        .form-group input::placeholder { color: #5a6a8a; }
        .form-group select option { background: #1a1a2e; color: #fff; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .photo-upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative; }
        .photo-upload-area:hover { border-color: #64ffda; }
        .photo-upload-area input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .photo-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
        .photo-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; }
        .photo-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview-item .remove-photo { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: #ff6b6b; border: none; border-radius: 50%; color: #fff; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, #64ffda 0%, #4fd1c5 100%); color: #1a1a2e; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-danger { background: #ff6b6b; color: #fff; }
        .btn-whatsapp { background: #25D366; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-share-link { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .property-list { display: flex; flex-direction: column; gap: 16px; }
        .property-card { background: rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .property-image-carousel { position: relative; width: 100%; height: 200px; background: rgba(255,255,255,0.1); }
        .property-image-carousel img { width: 100%; height: 100%; object-fit: cover; }
        .property-image-carousel .no-image { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #5a6a8a; font-size: 3rem; }
        .carousel-nav { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; }
        .carousel-dot.active { background: #64ffda; }
        .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; color: #fff; font-size: 18px; cursor: pointer; }
        .carousel-btn.prev { left: 10px; }
        .carousel-btn.next { right: 10px; }
        .image-count { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; }
        .property-info { padding: 16px; }
        .property-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: #fff; }
        .property-address { color: #8892b0; font-size: 0.85rem; margin-bottom: 12px; }
        .property-price { font-size: 1.4rem; font-weight: 700; color: #64ffda; margin-bottom: 12px; }
        .property-matricula { background: rgba(100, 255, 218, 0.1); border: 1px solid rgba(100, 255, 218, 0.3); padding: 10px 14px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 12px; }
        .property-matricula strong { color: #64ffda; font-size: 1.1rem; }
        .property-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .tag { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .tag-green { background: rgba(100, 255, 218, 0.2); color: #64ffda; }
        .tag-yellow { background: rgba(255, 214, 0, 0.2); color: #ffd600; }
        .tag-red { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .property-obs { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; font-size: 0.85rem; color: #8892b0; margin-bottom: 12px; }
        .property-actions { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); }
        .action-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; }
        .action-btn.edit { background: rgba(100, 255, 218, 0.2); color: #64ffda; }
        .action-btn.share { background: rgba(37, 211, 102, 0.2); color: #25D366; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state-icon { font-size: 4rem; margin-bottom: 20px; }
        .empty-state h3 { color: #ccd6f6; margin-bottom: 10px; }
        .empty-state p { color: #8892b0; margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: #1a1a2e; border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: #8892b0; font-size: 1.5rem; cursor: pointer; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #64ffda; color: #1a1a2e; padding: 12px 24px; border-radius: 30px; font-weight: 500; z-index: 2000; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        .search-bar { position: relative; margin-bottom: 20px; }
        .search-bar input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-size: 1rem; }
        .search-bar::before { content: "üîç"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); }
        .loading { text-align: center; padding: 40px; color: #8892b0; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #64ffda; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .share-link-box { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 16px 0; word-break: break-all; font-size: 0.85rem; color: #64ffda; }
        .viewer-header { background: linear-gradient(135deg, #64ffda 0%, #4fd1c5 100%); color: #1a1a2e; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; }
        .viewer-header h2 { margin-bottom: 5px; }
        .viewer-header p { opacity: 0.8; font-size: 0.9rem; }
        .contact-btn { display: block; width: calc(100% - 32px); padding: 16px; background: #25D366; color: #fff; text-decoration: none; border-radius: 12px; text-align: center; font-weight: 600; position: fixed; bottom: 20px; left: 16px; max-width: 468px; z-index: 100; }
        .fab { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #64ffda 0%, #4fd1c5 100%); color: #1a1a2e; border: none; font-size: 1.8rem; cursor: pointer; box-shadow: 0 4px 20px rgba(100, 255, 218, 0.4); display: none; align-items: center; justify-content: center; z-index: 100; }
        .fab.show { display: flex; }
        .header-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .header-buttons .btn { max-width: 180px; padding: 12px 16px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="config-banner" id="configBanner">
            <h3>‚öôÔ∏è Configura√ß√£o Necess√°ria</h3>
            <p>Configure o Supabase para come√ßar</p>
            <button onclick="openConfigModal()">Configurar Agora</button>
        </div>

        <div class="header" id="mainHeader" style="display: none;">
            <h1>üè† Meu Cat√°logo</h1>
            <p>Gerencie seus im√≥veis</p>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalImoveis">0</div>
                    <div class="stat-label">Im√≥veis</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="valorTotal">R$ 0</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>
            <div class="header-buttons">
                <button class="btn btn-share-link" onclick="openShareCatalogModal()">üîó Link Cat√°logo</button>
                <button class="btn btn-secondary" onclick="openConfigModal()">‚öôÔ∏è Config</button>
            </div>
        </div>

        <div class="viewer-header" id="viewerHeader" style="display: none;">
            <h2>üè† Cat√°logo de Im√≥veis</h2>
            <p id="viewerSubtitle">Im√≥veis dispon√≠veis</p>
        </div>

        <div class="tabs" id="adminTabs" style="display: none;">
            <div class="tab active" onclick="showTab('cadastro')">‚ûï Cadastrar</div>
            <div class="tab" onclick="showTab('catalogo')">üìã Cat√°logo</div>
        </div>

        <div id="cadastro" class="form-section">
            <form id="propertyForm">
                <div class="form-group">
                    <label>üìç Nome do Im√≥vel</label>
                    <input type="text" id="nome" placeholder="Ex: Casa Bairro X, Apto Centro..." required>
                </div>
                <div class="form-group">
                    <label>üó∫Ô∏è Endere√ßo Completo</label>
                    <input type="text" id="endereco" placeholder="Rua, n√∫mero, bairro, cidade" required>
                </div>
                <div class="form-group">
                    <label>üí∞ Valor de Venda</label>
                    <input type="text" id="valor" placeholder="R$ 0,00" oninput="formatCurrency(this)" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>üìã Avalia√ß√£o?</label>
                        <select id="avaliacao">
                            <option value="sim">‚úÖ Sim</option>
                            <option value="nao" selected>‚ùå N√£o</option>
                            <option value="andamento">‚è≥ Em andamento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìÑ Matr√≠cula?</label>
                        <select id="temMatricula">
                            <option value="sim">‚úÖ Sim</option>
                            <option value="nao" selected>‚ùå N√£o</option>
                            <option value="terceiro">üë§ Terceiro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>üî¢ N√∫mero da Matr√≠cula</label>
                    <input type="text" id="numeroMatricula" placeholder="Ex: 123.456">
                </div>
                <div class="form-group">
                    <label>üìù Observa√ß√µes</label>
                    <textarea id="observacoes" rows="3" placeholder="Detalhes do im√≥vel..."></textarea>
                </div>
                <div class="form-group">
                    <label>üì∏ Fotos (at√© 5)</label>
                    <div class="photo-upload-area">
                        <div>üì∑ Toque para adicionar fotos</div>
                        <input type="file" id="fotos" accept="image/*" multiple onchange="previewPhotos(this, 'photoPreviewGrid')">
                    </div>
                    <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">‚úÖ Cadastrar Im√≥vel</button>
            </form>
        </div>

        <div id="catalogo" class="form-section">
            <div class="search-bar"><input type="text" id="searchInput" placeholder="Buscar im√≥vel..." oninput="filterProperties()"></div>
            <div class="loading" id="loadingState"><div class="spinner"></div><p>Carregando...</p></div>
            <div class="property-list" id="propertyList"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">üè†</div>
                <h3>Nenhum im√≥vel</h3>
                <p>Cadastre seu primeiro im√≥vel</p>
            </div>
        </div>

        <a href="#" class="contact-btn" id="contactBtn" style="display: none;">üì± Chamar no WhatsApp</a>
    </div>

    <button class="fab" id="fabAdd" onclick="showTab('cadastro')">+</button>

    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Configurar</div>
                <button class="modal-close" onclick="closeConfigModal()">√ó</button>
            </div>
            <div class="form-group"><label>URL do Projeto</label><input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co"></div>
            <div class="form-group"><label>Chave Anon</label><input type="text" id="supabaseKey" placeholder="eyJ..."></div>
            <div class="form-group"><label>WhatsApp (com DDD)</label><input type="text" id="whatsappNumber" placeholder="5551999999999"></div>
            <div class="form-group"><label>Nome / Empresa</label><input type="text" id="ownerName" placeholder="Jo√£o"></div>
            <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar</button>
        </div>
    </div>

    <div class="modal" id="shareCatalogModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üîó Compartilhar</div>
                <button class="modal-close" onclick="closeShareCatalogModal()">√ó</button>
            </div>
            <p style="color: #8892b0; margin-bottom: 16px; font-size: 0.9rem;">Corretores v√£o <strong>visualizar</strong> (sem editar)</p>
            <div class="share-link-box" id="catalogLinkBox"></div>
            <button class="btn btn-primary" onclick="copyCatalogLink()">üìã Copiar Link</button>
            <button class="btn btn-whatsapp" onclick="shareCatalogWhatsApp()">üì± WhatsApp</button>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Editar</div>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>üìç Nome</label><input type="text" id="editNome" required></div>
                <div class="form-group"><label>üó∫Ô∏è Endere√ßo</label><input type="text" id="editEndereco" required></div>
                <div class="form-group"><label>üí∞ Valor</label><input type="text" id="editValor" oninput="formatCurrency(this)" required></div>
                <div class="form-row">
                    <div class="form-group"><label>üìã Avalia√ß√£o</label><select id="editAvaliacao"><option value="sim">‚úÖ Sim</option><option value="nao">‚ùå N√£o</option><option value="andamento">‚è≥</option></select></div>
                    <div class="form-group"><label>üìÑ Matr√≠cula</label><select id="editTemMatricula"><option value="sim">‚úÖ Sim</option><option value="nao">‚ùå N√£o</option><option value="terceiro">üë§</option></select></div>
                </div>
                <div class="form-group"><label>üî¢ N¬∫ Matr√≠cula</label><input type="text" id="editNumeroMatricula"></div>
                <div class="form-group"><label>üìù Obs</label><textarea id="editObservacoes" rows="2"></textarea></div>
                <div class="form-group"><label>üì∏ Fotos Atuais</label><div id="editCurrentPhotos"></div></div>
                <div class="form-group"><label>‚ûï Novas Fotos</label><div class="photo-upload-area"><div>üì∑ Adicionar</div><input type="file" id="editFotos" accept="image/*" multiple onchange="previewPhotos(this, 'editPhotoPreviewGrid')"></div><div class="photo-preview-grid" id="editPhotoPreviewGrid"></div></div>
                <button type="submit" class="btn btn-primary">üíæ Salvar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è Excluir</button>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let SUPABASE_URL = localStorage.getItem('supabase_url') || '';
        let SUPABASE_KEY = localStorage.getItem('supabase_key') || '';
        let OWNER_WHATSAPP = localStorage.getItem('owner_whatsapp') || '';
        let OWNER_NAME = localStorage.getItem('owner_name') || '';
        let supabase = null, properties = [], editingId = null, pendingPhotos = [], editPendingPhotos = [], editCurrentPhotos = [], isViewerMode = false;

        function checkViewerMode() {
            isViewerMode = new URLSearchParams(window.location.search).has('view');
            if (isViewerMode) {
                document.getElementById('configBanner').style.display = 'none';
                document.getElementById('mainHeader').style.display = 'none';
                document.getElementById('viewerHeader').style.display = 'block';
                document.getElementById('adminTabs').style.display = 'none';
                document.getElementById('cadastro').style.display = 'none';
                document.getElementById('catalogo').classList.add('active');
                document.getElementById('catalogo').style.display = 'block';
                document.getElementById('fabAdd').style.display = 'none';
                if (OWNER_WHATSAPP) {
                    const btn = document.getElementById('contactBtn');
                    btn.style.display = 'block';
                    btn.href = 'https://wa.me/' + OWNER_WHATSAPP + '?text=Ol√°! Vi seu cat√°logo e tenho interesse.';
                }
                if (OWNER_NAME) document.getElementById('viewerSubtitle').textContent = 'Cat√°logo de ' + OWNER_NAME;
            }
        }

        function initSupabase() {
            if (SUPABASE_URL && SUPABASE_KEY) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                document.getElementById('configBanner').style.display = 'none';
                if (!isViewerMode) {
                    document.getElementById('mainHeader').style.display = 'block';
                    document.getElementById('adminTabs').style.display = 'flex';
                    document.getElementById('cadastro').classList.add('active');
                }
                loadProperties();
                return true;
            }
            return false;
        }

        function openConfigModal() {
            document.getElementById('supabaseUrl').value = SUPABASE_URL;
            document.getElementById('supabaseKey').value = SUPABASE_KEY;
            document.getElementById('whatsappNumber').value = OWNER_WHATSAPP;
            document.getElementById('ownerName').value = OWNER_NAME;
            document.getElementById('configModal').classList.add('active');
        }
        function closeConfigModal() { document.getElementById('configModal').classList.remove('active'); }

        function saveConfig() {
            SUPABASE_URL = document.getElementById('supabaseUrl').value.trim();
            SUPABASE_KEY = document.getElementById('supabaseKey').value.trim();
            OWNER_WHATSAPP = document.getElementById('whatsappNumber').value.replace(/\D/g, '');
            OWNER_NAME = document.getElementById('ownerName').value.trim();
            localStorage.setItem('supabase_url', SUPABASE_URL);
            localStorage.setItem('supabase_key', SUPABASE_KEY);
            localStorage.setItem('owner_whatsapp', OWNER_WHATSAPP);
            localStorage.setItem('owner_name', OWNER_NAME);
            closeConfigModal();
            initSupabase() ? showToast('‚úÖ Salvo!') : showToast('‚ùå Preencha tudo');
        }

        async function loadProperties() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('propertyList').innerHTML = '';
            try {
                const { data, error } = await supabase.from('imoveis').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                properties = data || [];
                updateStats();
                renderProperties();
            } catch (e) { console.error(e); showToast('‚ùå Erro'); }
            document.getElementById('loadingState').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('totalImoveis').textContent = properties.length;
            const total = properties.reduce((s, p) => s + (parseFloat(String(p.valor).replace(/\D/g, '')) || 0), 0);
            document.getElementById('valorTotal').textContent = total >= 1e6 ? 'R$ ' + (total/1e6).toFixed(1) + 'M' : total >= 1e3 ? 'R$ ' + (total/1e3).toFixed(0) + 'K' : 'R$ ' + total;
        }

        function formatCurrency(el) {
            let v = el.value.replace(/\D/g, '');
            if (!v) { el.value = ''; return; }
            v = (parseInt(v) / 100).toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            el.value = 'R$ ' + v;
        }

        function previewPhotos(input, gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            const isEdit = gridId === 'editPhotoPreviewGrid';
            if (isEdit) editPendingPhotos = []; else pendingPhotos = [];
            Array.from(input.files).slice(0, 5).forEach((file, i) => {
                (isEdit ? editPendingPhotos : pendingPhotos).push(file);
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item';
                    div.innerHTML = '<img src="' + e.target.result + '"><button type="button" class="remove-photo" onclick="this.parentElement.remove()">√ó</button>';
                    grid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderCurrentPhotos() {
            const c = document.getElementById('editCurrentPhotos');
            if (!editCurrentPhotos.length) { c.innerHTML = '<p style="color:#8892b0;font-size:0.85rem">Sem fotos</p>'; return; }
            c.innerHTML = '<div class="photo-preview-grid">' + editCurrentPhotos.map((url, i) => '<div class="photo-preview-item"><img src="' + url + '"><button type="button" class="remove-photo" onclick="removeCurrentPhoto(' + i + ')">√ó</button></div>').join('') + '</div>';
        }

        function removeCurrentPhoto(i) { editCurrentPhotos.splice(i, 1); renderCurrentPhotos(); }

        async function uploadPhotos(id, files) {
            const urls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i], ext = file.name.split('.').pop(), name = id + '/' + Date.now() + '_' + i + '.' + ext;
                const { error } = await supabase.storage.from('imoveis-fotos').upload(name, file);
                if (!error) urls.push(supabase.storage.from('imoveis-fotos').getPublicUrl(name).data.publicUrl);
            }
            return urls;
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.querySelector('.tab:nth-child(' + (tab === 'cadastro' ? 1 : 2) + ')').classList.add('active');
            document.getElementById(tab).classList.add('active');
            document.getElementById('fabAdd').classList.toggle('show', tab === 'catalogo' && !isViewerMode);
            if (tab === 'catalogo') loadProperties();
        }

        document.getElementById('propertyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.textContent = '‚è≥ Salvando...';
            try {
                const data = { nome: document.getElementById('nome').value, endereco: document.getElementById('endereco').value, valor: document.getElementById('valor').value, avaliacao: document.getElementById('avaliacao').value, tem_matricula: document.getElementById('temMatricula').value, numero_matricula: document.getElementById('numeroMatricula').value || null, observacoes: document.getElementById('observacoes').value || null, fotos: [] };
                const { data: d, error } = await supabase.from('imoveis').insert([data]).select().single();
                if (error) throw error;
                if (pendingPhotos.length) {
                    const urls = await uploadPhotos(d.id, pendingPhotos);
                    await supabase.from('imoveis').update({ fotos: urls }).eq('id', d.id);
                }
                document.getElementById('propertyForm').reset();
                document.getElementById('photoPreviewGrid').innerHTML = '';
                pendingPhotos = [];
                showToast('‚úÖ Cadastrado!');
                setTimeout(() => showTab('catalogo'), 500);
            } catch (e) { console.error(e); showToast('‚ùå Erro'); }
            btn.disabled = false; btn.textContent = '‚úÖ Cadastrar Im√≥vel';
        });

        function renderProperties() {
            const list = document.getElementById('propertyList'), empty = document.getElementById('emptyState'), search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const filtered = properties.filter(p => p.nome.toLowerCase().includes(search) || p.endereco.toLowerCase().includes(search));
            if (!filtered.length) { list.innerHTML = ''; empty.style.display = 'block'; return; }
            empty.style.display = 'none';
            list.innerHTML = filtered.map(p => {
                const fotos = p.fotos || [], has = fotos.length > 0;
                return '<div class="property-card"><div class="property-image-carousel" data-id="' + p.id + '" data-index="0">' + (has ? '<img src="' + fotos[0] + '" id="carousel-img-' + p.id + '">' + (fotos.length > 1 ? '<button class="carousel-btn prev" onclick="carouselNav(\'' + p.id + '\',-1,event)">‚Äπ</button><button class="carousel-btn next" onclick="carouselNav(\'' + p.id + '\',1,event)">‚Ä∫</button><div class="carousel-nav">' + fotos.map((_, i) => '<div class="carousel-dot' + (i === 0 ? ' active' : '') + '" onclick="carouselGo(\'' + p.id + '\',' + i + ',event)"></div>').join('') + '</div>' : '') + '<span class="image-count">üì∑ ' + fotos.length + '</span>' : '<div class="no-image">üè†</div>') + '</div><div class="property-info"><div class="property-name">' + p.nome + '</div><div class="property-address">üìç ' + p.endereco + '</div><div class="property-price">' + p.valor + '</div>' + (p.numero_matricula ? '<div class="property-matricula">üìÑ Matr√≠cula n¬∫ <strong>' + p.numero_matricula + '</strong></div>' : '') + '<div class="property-tags"><span class="tag ' + (p.avaliacao === 'sim' ? 'tag-green' : p.avaliacao === 'andamento' ? 'tag-yellow' : 'tag-red') + '">' + (p.avaliacao === 'sim' ? '‚úÖ Avaliado' : p.avaliacao === 'andamento' ? '‚è≥ Avaliando' : '‚ùå Sem avalia√ß√£o') + '</span><span class="tag ' + (p.tem_matricula === 'sim' ? 'tag-green' : p.tem_matricula === 'terceiro' ? 'tag-yellow' : 'tag-red') + '">' + (p.tem_matricula === 'sim' ? 'üìÑ Matr√≠cula OK' : p.tem_matricula === 'terceiro' ? 'üë§ Terceiro' : '‚ùå Sem matr√≠cula') + '</span></div>' + (p.observacoes ? '<div class="property-obs">üìù ' + p.observacoes + '</div>' : '') + (!isViewerMode ? '<div class="property-actions"><button class="action-btn edit" onclick="openEditModal(\'' + p.id + '\')">‚úèÔ∏è Editar</button><button class="action-btn share" onclick="shareProperty(\'' + p.id + '\')">üì§ WhatsApp</button></div>' : '') + '</div></div>';
            }).join('');
        }

        function carouselNav(id, dir, e) { e?.stopPropagation(); const p = properties.find(x => x.id === id); if (!p?.fotos) return; const c = document.querySelector('.property-image-carousel[data-id="' + id + '"]'); let i = parseInt(c.dataset.index) + dir; if (i < 0) i = p.fotos.length - 1; if (i >= p.fotos.length) i = 0; updateCarousel(id, i, p.fotos); }
        function carouselGo(id, i, e) { e?.stopPropagation(); const p = properties.find(x => x.id === id); if (p?.fotos) updateCarousel(id, i, p.fotos); }
        function updateCarousel(id, i, fotos) { const c = document.querySelector('.property-image-carousel[data-id="' + id + '"]'); c.dataset.index = i; document.getElementById('carousel-img-' + id).src = fotos[i]; c.querySelectorAll('.carousel-dot').forEach((d, j) => d.classList.toggle('active', j === i)); }
        function filterProperties() { renderProperties(); }

        function openEditModal(id) {
            const p = properties.find(x => x.id === id); if (!p) return;
            editingId = id;
            editCurrentPhotos = [...(p.fotos || [])];
            editPendingPhotos = [];
            document.getElementById('editId').value = id;
            document.getElementById('editNome').value = p.nome;
            document.getElementById('editEndereco').value = p.endereco;
            document.getElementById('editValor').value = p.valor;
            document.getElementById('editAvaliacao').value = p.avaliacao;
            document.getElementById('editTemMatricula').value = p.tem_matricula;
            document.getElementById('editNumeroMatricula').value = p.numero_matricula || '';
            document.getElementById('editObservacoes').value = p.observacoes || '';
            renderCurrentPhotos();
            document.getElementById('editPhotoPreviewGrid').innerHTML = '';
            document.getElementById('editFotos').value = '';
            document.getElementById('editModal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); editingId = null; }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                let all = [...editCurrentPhotos];
                if (editPendingPhotos.length) all = [...all, ...(await uploadPhotos(editingId, editPendingPhotos))];
                await supabase.from('imoveis').update({ nome: document.getElementById('editNome').value, endereco: document.getElementById('editEndereco').value, valor: document.getElementById('editValor').value, avaliacao: document.getElementById('editAvaliacao').value, tem_matricula: document.getElementById('editTemMatricula').value, numero_matricula: document.getElementById('editNumeroMatricula').value || null, observacoes: document.getElementById('editObservacoes').value || null, fotos: all }).eq('id', editingId);
                closeEditModal(); loadProperties(); showToast('‚úÖ Atualizado!');
            } catch (e) { console.error(e); showToast('‚ùå Erro'); }
        });

        function confirmDelete() { if (confirm('Excluir este im√≥vel?')) deleteProperty(); }
        async function deleteProperty() { await supabase.from('imoveis').delete().eq('id', editingId); closeEditModal(); loadProperties(); showToast('üóëÔ∏è Exclu√≠do'); }

        function shareProperty(id) {
            const p = properties.find(x => x.id === id); if (!p) return;
            const link = location.origin + location.pathname + '?view=1';
            let t = 'üè† *' + p.nome + '*\n\nüìç ' + p.endereco + '\nüí∞ *' + p.valor + '*\n';
            if (p.numero_matricula) t += 'üìÑ Matr√≠cula: *' + p.numero_matricula + '*\n';
            t += '\nüîó *Ver cat√°logo com fotos:*\n' + link;
            window.open('https://wa.me/?text=' + encodeURIComponent(t), '_blank');
        }

        function openShareCatalogModal() { document.getElementById('catalogLinkBox').textContent = location.origin + location.pathname + '?view=1'; document.getElementById('shareCatalogModal').classList.add('active'); }
        function closeShareCatalogModal() { document.getElementById('shareCatalogModal').classList.remove('active'); }
        function copyCatalogLink() { navigator.clipboard.writeText(document.getElementById('catalogLinkBox').textContent); showToast('üìã Copiado!'); }
        function shareCatalogWhatsApp() { const t = 'üè† *Cat√°logo de Im√≥veis' + (OWNER_NAME ? ' - ' + OWNER_NAME : '') + '*\n\nVeja os im√≥veis com fotos:\n' + document.getElementById('catalogLinkBox').textContent; window.open('https://wa.me/?text=' + encodeURIComponent(t), '_blank'); }

        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

        checkViewerMode();
        initSupabase();
    </script>
</body>
</html>
